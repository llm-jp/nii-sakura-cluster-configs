---
- hosts: all
  become: yes
  gather_facts: no

  tasks:
    - name: set gpu power limit
      ansible.builtin.command: nvidia-smi -i 0,1,2,3,4,5,6,7 -pl 600
      when: "'a0' in inventory_hostname"

    - name: check if power limit is in place
      ansible.builtin.command: bash -c "if [ \"$(nvidia-smi --query-gpu=index,power.limit --format=csv | head -n 2 | tail -n1)\" = \"0, 600.00 W\" ]; then echo \"$(hostname)\:\ Power limit set to 600W\"; else echo \"$(hostname)\:\ ERROR!\:\ Power limit is $(nvidia-smi --query-gpu=power.limit --format=csv | head -n 2 | tail -n1)\";exit -1; fi"
      register: output
      when: "'a0' in inventory_hostname"


    

